<!DOCTYPE html>
<html>
<head>
    <title>Async Processing with SSE</title>
</head>
<body>
    <input type="text" id="keyword" placeholder="Enter keywords separated by commas">
    <input type="file" id="fileInput" accept=".csv">
    <button onclick="submitKeywords()">Submit</button>
    <div id="results"></div>

    <script>
        function submitKeywords() {
            const keywordInput = document.getElementById('keyword').value;
            const fileInput = document.getElementById('fileInput').files[0];

            if (keywordInput) {
                sendKeywordsToBackend(keywordInput.split(',').map(keyword => keyword.trim()).filter(Boolean));
            } else if (fileInput) {
                processFile(fileInput);
            }
        }

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const content = event.target.result;
                const keywords = content.split(',').map(keyword => keyword.trim()).filter(Boolean);
                sendKeywordsToBackend(keywords);
            };
            reader.readAsText(file);
        }

        function sendKeywordsToBackend(keywords) {
            fetch('https://kgrsse.v2ray-tokyo.workers.dev/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ keywords: keywords })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Batch submitted:', data);
                startSSE(data.batchId);
            })
            .catch(error => {
                console.error('Error submitting batch:', error);
            });
        }

        function startSSE(batchId) {
            const eventSource = new EventSource(`https://kgrsse.v2ray-tokyo.workers.dev/results?batchId=${batchId}`);
            eventSource.onmessage = function(event) {
                const results = JSON.parse(event.data);
                displayResults(results);
            };

            eventSource.onerror = function(event) {
                console.error('SSE error:', event);
                eventSource.close();
            };
        }

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = ''; // Clear previous results

            results.forEach(result => {
                const resultElement = document.createElement('div');
                resultElement.innerHTML = `
                    <p>Keyword: ${result.keyword}</p>
                    <p>Intitle Count: ${result.intitle}</p>
                    <p>Allintitle Count: ${result.allintitle}</p>
                `;
                resultsDiv.appendChild(resultElement);
            });
        }
    </script>
</body>
</html>
