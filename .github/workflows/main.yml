name: Google Crawler branch save
on:
  workflow_dispatch:
    inputs:
      id:
        description: "Task ID for result naming"
        required: true
      keywords:
        description: "Comma-separated keywords"
        required: true
      branch_name:
        description: "Branch name for results"
        required: true

jobs:
  run-crawler:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Add this line to ensure write permissions
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.branch_name }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install playwright crawlee axios csv-parse mysql2
          npx playwright install firefox

      - name: Run crawler
        run: |
          mkdir -p results
          node main-pl.js "${{ inputs.id }}" "${{ inputs.keywords }}" "input.csv"

      - name: Commit and push results
        run: |
          git add results/${{ inputs.id }}.csv
          git commit -m "Add results for task ID: ${{ inputs.id }}"
          git push origin ${{ inputs.branch_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
